<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DONY BURGUER'S - SISTEMA OFICIAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --gold: #f59e0b; --dark: #050b1a; --card: #111827; --green: #10b981; --red: #ef4444; }
        body { font-family: sans-serif; background: var(--dark); color: white; margin: 0; padding: 10px; }
        .botao-secreto { position: absolute; top: 0; left: 0; width: 80px; height: 80px; background: transparent; z-index: 1000; }
        .visor-total { background: #000; border: 2px solid var(--gold); border-radius: 12px; padding: 15px; text-align: center; margin-bottom: 15px; }
        .visor-total strong { font-size: 34px; color: white; }
        .btn-lanche { background: white; color: #000; border: none; padding: 18px; border-radius: 8px; font-weight: bold; width: 75%; text-align: left; }
        .btn-carrinho-x { background: var(--red); color: white; border: none; width: 20%; padding: 18px; border-radius: 8px; font-weight: bold; float: right; }
        #painel-admin { display: none; background: #1f2937; border: 2px solid var(--gold); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        #tela-pagamento { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; text-align: center; padding-top: 40px; }
        .caixa-pagamento { background: #fff; color: #000; width: 85%; max-width: 320px; margin: 0 auto; padding: 20px; border-radius: 20px; border: 5px solid var(--gold); }
        .item-gestao { display: flex; justify-content: space-between; background: #374151; padding: 8px; margin-top: 5px; border-radius: 5px; font-size: 14px; }
    </style>
</head>
<body>
    <div style="color: white; font-size: 10px; text-align: center; padding: 5px; font-weight: bold;">Criado e desenvolvido por Jos√© Divino Plata da Lapa Engenheiro s√™nio</div>
    <div class="botao-secreto" onclick="abrirEscritorio()"></div>
    <div class="no-print">
        <div id="painel-admin">
            <h3 style="color:var(--gold); text-align:center; margin-top:0;">GEST√ÉO DO CARD√ÅPIO</h3>
            <button onclick="conectarImpressora()" style="width:100%; background: #3b82f6; color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; margin-bottom:15px;">üîå CONECTAR IMPRESSORA</button>
            <input type="text" id="novoNome" style="width:92%; padding:10px; margin-bottom:5px;" placeholder="Nome do Lanche">
            <input type="number" id="novoPreco" style="width:92%; padding:10px; margin-bottom:10px;" placeholder="Pre√ßo R$">
            <button onclick="adicionarAoCardapio()" style="width:100%; background:var(--green); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold;">‚ûï ADICIONAR ITEM NOVO</button>
            <div id="lista-gestao" style="margin-top:15px; max-height: 150px; overflow-y: auto; border-top: 1px solid #4b5563; padding-top: 10px;"></div>
            <button onclick="document.getElementById('painel-admin').style.display='none'" style="background:gray; color:white; width:100%; padding:8px; border:none; border-radius:8px; margin-top:10px;">FECHAR PAINEL</button>
        </div>
        <div class="visor-total"><small style="color:var(--gold)">VALOR TOTAL</small><br><strong id="totalDisplay">R$ 0,00</strong></div>
        <div id="listaBotoes"></div>
        <button onclick="finalizarPedido()" style="background:var(--green); color:white; width:100%; padding:22px; border:none; border-radius:12px; font-weight:bold; font-size:18px; margin-top:15px;">CONCLUIR PEDIDO</button>
    </div>
    <div id="tela-pagamento">
        <div class="caixa-pagamento">
            <h3 style="margin:0; color:#333;">PAGAMENTO PIX</h3>
            <div id="qrcode-tela" style="margin: 15px 0; display: flex; justify-content: center;"></div>
            <p id="valorTela" style="font-weight:bold; font-size:22px; color:#d4af37; margin:5px 0;"></p>
            <button id="btnImprimir" onclick="imprimirDireto()" style="background:var(--green); color:white; width:100%; padding:18px; border:none; border-radius:10px; font-weight:bold; font-size:16px;">IMPRIMIR COMPROVANTE</button>
            <button onclick="fecharPagamentoSeguro()" style="background:#eee; color:#333; width:100%; padding:10px; border:none; border-radius:10px; margin-top:10px;">VOLTAR</button>
        </div>
    </div>
    <script>
        const _S = "drkling2025";
        const CHAVE_PIX = "00020126580014br.gov.bcb.pix013643a6f5e6-2934-495f-a96c-f7eaf67d28da5204000053039865802BR5925JOSE DIVINO PRADO DA LAPA6009SAO PAULO62580520SAN2026010115161607950300017br.gov.bcb.brcode01051.0.06304A53A";
        let cardapio = JSON.parse(localStorage.getItem('cardapio_dony')) || [{n:"Kik√£o",p:6.00}, {n:"X salada",p:10.00}, {n:"Pastel",p:3.00}];
        let pedido = [], caractImp = null;

        function abrirEscritorio() { if(prompt("ACESSO ADMINISTRADOR:") === _S) { document.getElementById('painel-admin').style.display='block'; atualizarGestao(); } }
        function fecharPagamentoSeguro() { if(prompt("SENHA PARA CANCELAR:") === _S) document.getElementById('tela-pagamento').style.display='none'; }
        
        async function conectarImpressora() {
            try {
                const disp = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: '58' }, { namePrefix: 'MPT' }, { namePrefix: 'Bluetooth' }], optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb'] });
                const serv = await (await disp.gatt.connect()).getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                const caracts = await serv.getCharacteristics();
                caractImp = caracts.find(c => c.properties.write || c.properties.writeWithoutResponse);
                alert("IMPRESSORA PRONTA!");
            } catch (e) { alert("Ligue o Bluetooth."); }
        }

        async function imprimirDireto() {
            if (!caractImp) return alert("Conecte a impressora primeiro!");
            const encoder = new TextEncoder(), ESC = '\x1B', GS = '\x1D', Cent = ESC + 'a' + '\x01', Esq = ESC + 'a' + '\x00', B1 = ESC + 'E' + '\x01', B0 = ESC + 'E' + '\x00', Res = ESC + '@';
            
            let t = Res + Cent + B1 + "JOSE DIVINO - ENG. SENIOR\n" + "DONY BURGUER\n" + "--------------------------------\n" + B0 + Esq;
            pedido.forEach(i => { t += `${i.n.padEnd(18)} R$ ${i.p.toFixed(2)}\n`; });
            t += "--------------------------------\n" + Cent + B1 + `TOTAL: ${document.getElementById('totalDisplay').innerText}\n\n`;
            
            // COMANDOS DO QR CODE PARA A IMPRESSORA
            t += B0 + "PAGUE PELO QR CODE ABAIXO:\n";
            t += GS + "(k\x03\x001C\x08"; // Define o tamanho bacana
            t += GS + "(k\x03\x001E\x00"; // Corre√ß√£o de erro
            t += GS + "(k" + String.fromCharCode(CHAVE_PIX.length + 3) + "\x001P0" + CHAVE_PIX; // Envia a Chave
            t += GS + "(k\x03\x001Q0"; // Imprime o QR
            
            t += "\n\nVOLTE SEMPRE!\n\n\n\n\n";

            try {
                const dados = encoder.encode(t);
                for (let i = 0; i < dados.length; i += 20) {
                    await caractImp.writeValue(dados.slice(i, i + 20));
                    await new Promise(r => setTimeout(r, 50)); 
                }
                pedido = []; atualizar(); document.getElementById('tela-pagamento').style.display = 'none';
            } catch (e) { alert("Erro de impress√£o."); }
        }

        function renderizar() {
            document.getElementById('listaBotoes').innerHTML = cardapio.map(i => `<div style="margin-bottom:10px; display:flex; gap:5px;"><button class="btn-lanche" onclick="add('${i.n}', ${i.p})">${i.n} - R$ ${i.p.toFixed(2)}</button><button class="btn-carrinho-x" onclick="remPed('${i.n}')">X</button></div>`).join('');
        }

        function atualizarGestao() {
            document.getElementById('lista-gestao').innerHTML = cardapio.map((i, idx) => `<div class="item-gestao"><span>${i.n}</span><button onclick="removerDoCardapio(${idx})" style="background:none; border:none; color:var(--red); font-weight:bold;">EXCLUIR</button></div>`).join('');
        }

        function adicionarAoCardapio() {
            const n = document.getElementById('novoNome').value, p = parseFloat(document.getElementById('novoPreco').value);
            if(n && p) { cardapio.push({n, p}); localStorage.setItem('cardapio_dony', JSON.stringify(cardapio)); renderizar(); atualizarGestao(); document.getElementById('novoNome').value = ''; document.getElementById('novoPreco').value = ''; }
        }

        function removerDoCardapio(idx) { if(confirm("Remover item?")) { cardapio.splice(idx, 1); localStorage.setItem('cardapio_dony', JSON.stringify(cardapio)); renderizar(); atualizarGestao(); } }
        function add(n, p) { pedido.push({n, p}); atualizar(); }
        function remPed(n) { if(prompt("SENHA ADMIN:") === _S) { const idx = pedido.findIndex(it => it.n === n); if(idx > -1) { pedido.splice(idx, 1); atualizar(); } } }
        function atualizar() { let t = pedido.reduce((acc, i) => acc + i.p, 0); document.getElementById('totalDisplay').innerText = `R$ ${t.toFixed(2).replace('.',',')}`; }
        
        function finalizarPedido() {
            if(!pedido.length) return;
            document.getElementById('valorTela').innerText = document.getElementById('totalDisplay').innerText;
            document.getElementById("qrcode-tela").innerHTML = "";
            new QRCode(document.getElementById("qrcode-tela"), { text: CHAVE_PIX, width: 200, height: 200 });
            document.getElementById('tela-pagamento').style.display = 'block';
        }
        renderizar();
    </script>
</body>
</html>
